# Lab_5: Автоматизація за допомогою Makefile VS Docker Compose

1. Створюю папку `my_app`, в якій буде знаходитись проект. Створюю папку `tests` де будуть тести на перевірку працездатності проекту. Копіюю файли з репозиторію у відповідні папки мого репозиторію. Переглядаю файл `requirements.txt` у папці проекту та тестах.
2. Перевіряю чи проект є працездатним. Ініціалізувавши середовища, виконую наступні команди:
    ```
    pipenv --python 3.7
    pipenv install -r requirements.txt
    pipenv run python app.py
    ```
   - Виправляю помилку `redis.exceptions.ConnectionError`, що виникла при спробі запустити додатку;
   - Переконуюся, що головна сторінка працює:
      
     ![image](img/1.png)
     
    - Створюю папку `logs` для того, щоб працювали сторінки `/hits` та `/logs`. Переконуюся, що після цього вони працюють:
   
        ![image](img/2.png)
   
        ![image](img/3.png)
        
3. Ініціалузовую середовище для тестів у іншій вкладці терміналу та запускаю їх командою:
     ```
     pipenv run pytest test_app.py --url http://localhost:5000
     ```
   - Тести виконалися успішно:
   
    ![image](img/4.png)
    
    - Видаляю файли `Pipfile` та `Pipfile.lock`.
    
 4. Створюю два `Dockerfile` та `Makefile`, який допоможе автоматизувати процес розгортання.
 5. Ознайомлююся із вмістом Dockerfile та Makefile та його директивами:
     
     - `STATES` та `REPO` це змінні, які містять назви тегів та назву репозиторія `Docker Hub` відповідно;
     - `.PHONY `- утиліта `make`, яка вказує файлу, що переліченні нище цілі не являються файлами;
     - `$(STATES)` можна викликати просто підставляючи назву тегу і призначена для білду `Docker Image`;
     - `run` - ціль для створення мережі, у якій буде працювати додаток; запуску додатку і `redis`;
     - `test-app` для запуску тестів;
     - `docker-prune` для очищення ресурсів Docker.
 6.  Виконую наступну команду для створення `Docker` імеджів для додатку та для тестів:
     ```
     make .PHONY
     ```
7. Запускаю додаток та тести, виконавши команди: 
    ```
    make run
    make test-app
    ```
   - Перевіряю кожну сторінку сайту:
   
     ![image](img/5.png)
     
     ![image](img/6.png)
     
     ![image](img/7.png)
     
   - Результат виконання тестів:
   
     ![image](img/8.png)

8. Очищаю всі ресурси Docker за допомогою команди:
    ```
    make docker-prune
    ```
9. Створюю директиву в `Makefile` для завантаження створених імеджів у `Docker Hub` репозиторій. Завантажую імеджі до репозиторію командою:
    ```
    make docker-push
    ```
   
   - [Посилання на Docker Hub](https://hub.docker.com/repository/docker/legeia/lab5_devops);
   
10. Створюю директиву `delete-images` в `Makefile`, яка автоматизує процес видалення імеджів. Після виконання команди переконуюся, що імеджів немає:
     
     ![image](img/9.png)  

11. Створюю файл `docker-compose.yml` у папці проекту та заповнюю вмістом згідно прикладу. У нього з'являється дві мережі: `secret` і `public`:
     - У мережі `secret` знаходяться `app` і `redis`;
     - До мережі `public` відносяться `app` і `tests` ;
     - Таким чином `tests` i `redis` не мають доступу один до одного.